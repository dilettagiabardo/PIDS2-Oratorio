/**
 * main permette di smistare le mail ricevute in input. Se il valore di controllo è diverso da 1 allora va ad elaborare ed inviare le mail. Altrimenti va alla riga successiva.
 * Se la mail è presente nel database allora verrà inviata una mail con un link al sondaggio precompilato. Altrimenti verrà allegato il sondaggio non precompilato.
 *
 * @return In base al valore di controllo richiama la funzione di inviaMailPrecompilata o quella di invioMail
 * @customfunction
 */
function main(){
  var ssC = SpreadsheetApp.getActiveSpreadsheet();
  var sheetC = ssC.getSheetByName("Controllo"); 
  var rangeC = sheetC.getDataRange();
  var dataC = rangeC.getValues();

  var ssD = SpreadsheetApp.getActiveSpreadsheet();
  var sheetD = ssD.getSheetByName("Database"); 
  var rangeD = sheetD.getDataRange();
  var dataD = rangeD.getValues();

  for(var i = 1; i < dataC.length; i++){
    var controllo = dataC[i][2];
    var mailC = dataC[i][1];
    var a= "C"+(i+1);

    if(controllo!=1){
      for(var j=1; j<dataD.length; j++){
        var mailD = dataD[j][0];
        if(mailC===mailD){
          console.log("Trovato");
          inviaMailPrecompilata(j);
        }
      }
      var cella=sheetC.getRange(a).setValue(1);
    }
    if(controllo!=1){
      inviaMail(i);
      var cella=sheetC.getRange(a).setValue(1);
    }
    
  }

}

/**
 * Invia mail precompilata
 *
 * @param numero=il numero di riga dove si trova la mail
 * @return invia la mail con il link precompilato al sondaggio
 * @customfunction
 */
function inviaMailPrecompilata(numero) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Database"); 
  var range = sheet.getDataRange();
  var data = range.getValues();

  var nome = data[numero][2]; // Indice della colonna contenente i nomi 
  var email = ""+ data[numero][0]; // Indice della colonna contenente le email 
  var link = data[numero][4]; // Indice della colonna contenente i link associati ai nomi

  var oggetto = "Iscrizione";
  var corpo = "Buongiorno " + nome + ",\n\n" +
                "Di seguito trova il form precompilato rispetto agli anni precedenti:\n" +
                "" +link + "\n\n" +
                "Grazie,\n" +
                "Diletta";

  MailApp.sendEmail(
    (email),
    (oggetto),
    (corpo)
  );   
}

/**
 * Invia mail con link al sondaggio
 *
 * @param numero=il numero di riga dove si trova la mail
 * @return invia la mail con il link al sondaggio
 * @customfunction
 */
function inviaMail(numero) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Controllo"); 
  var range = sheet.getDataRange();
  var data = range.getValues();
  
  var email = data[numero][1]; // Indice della colonna contenente le email 

  var oggetto = "Iscrizione";
  var corpo = "Buongiorno,\n\n" +
                "Di seguito trova il form da compilare per l'iscrizione:\n" +
                "https://docs.google.com/forms/d/e/1FAIpQLSdpRdVVnOoQnIGOP5o6LqwDBf4QN1L6KfGYoFsVx3FDRprwWw/viewform?usp=sf_link" + "\n\n" +
                "Grazie,\n" +
                "Diletta";

  MailApp.sendEmail(
    (email),
    (oggetto),
    (corpo)
  ); 
}


